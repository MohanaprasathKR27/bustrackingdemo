<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multi-Bus Tracking Prototype ‚Äî Punjab Small Cities</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    #map { height: 520px; width: 100%; border: 1px solid #ccc; border-radius: 6px; }
    h2 { margin: 6px 0 12px; }
    .controls { margin: 8px 0; }
    button { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; margin-left:4px; }
    select { padding:4px 6px; margin-right:6px; }
    .bus-box { margin-top:10px; font-weight:bold; background:#f9f9f9; padding:6px; border-radius:5px; border:1px solid #ccc; }
    .bus-header { font-size:14px; font-weight:bold; margin-bottom:4px; }
  </style>
</head>
<body>
  <h2>üöç Multi-Bus Real-Time Tracking ‚Äî Punjab Small Cities</h2>
  
  <!-- Bus 1 Controls -->
  <div class="controls">
    <div class="bus-header">üöå Bus 1</div>
    <label>Start:
      <select id="start1">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <label>End:
      <select id="end1">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <button onclick="setRoute(1)">Set Route</button>
    <button onclick="startAnimation(1)">Start</button>
    <button onclick="resetAnimation(1)">Reset</button>
  </div>
  <div id="eta1" class="bus-box">‚ÑπÔ∏è Bus 1 info will appear here.</div>

  <!-- Bus 2 Controls -->
  <div class="controls">
    <div class="bus-header">üöå Bus 2</div>
    <label>Start:
      <select id="start2">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <label>End:
      <select id="end2">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <button onclick="setRoute(2)">Set Route</button>
    <button onclick="startAnimation(2)">Start</button>
    <button onclick="resetAnimation(2)">Reset</button>
  </div>
  <div id="eta2" class="bus-box">‚ÑπÔ∏è Bus 2 info will appear here.</div>

  <!-- Bus 3 Controls -->
  <div class="controls">
    <div class="bus-header">üöå Bus 3</div>
    <label>Start:
      <select id="start3">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <label>End:
      <select id="end3">
        <option value="patiala">Patiala</option>
        <option value="nabha">Nabha</option>
        <option value="morinda">Morinda</option>
        <option value="kurali">Kurali</option>
        <option value="sirhind">Sirhind</option>
      </select>
    </label>
    <button onclick="setRoute(3)">Set Route</button>
    <button onclick="startAnimation(3)">Start</button>
    <button onclick="resetAnimation(3)">Reset</button>
  </div>
  <div id="eta3" class="bus-box">‚ÑπÔ∏è Bus 3 info will appear here.</div>

  <!-- Help & Alarm -->
  <div class="controls">
    <button id="helpBtn">Help</button>
    <button id="alarmBtn" style="background:red; color:white;">Secure Alarm</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  const cityOrder = [
    { name: "patiala", coords: [30.3398, 76.3869] },
    { name: "nabha",   coords: [30.3745, 76.1520] },
    { name: "morinda", coords: [30.6380, 76.5110] },
    { name: "kurali",  coords: [30.6820, 76.7400] },
    { name: "sirhind", coords: [30.6450, 76.3841] }
  ];

  const BUS_SPEED_MPS = 27.7; // ~100 km/h
  const colors = ["#2E86AB","#28B463","#AF7AC5"]; // 3 routes

  // Map
  const map = L.map('map').setView(cityOrder[0].coords, 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' }).addTo(map);

  // City markers
  cityOrder.forEach(c => {
    L.circleMarker(c.coords, {radius:6, fill:true, color:'#ff5c5c', fillOpacity:1})
      .addTo(map).bindPopup(c.name.charAt(0).toUpperCase()+c.name.slice(1));
  });

  // Bus Data Structures
  let buses = {
    1: { route:[], poly:null, marker:null, distances:[], animating:false, seg:0, segStart:null, segEnd:null,
         segDur:0, segStartTime:null, raf:null, total:0, covered:0, lastKmMilestone:0 },
    2: { route:[], poly:null, marker:null, distances:[], animating:false, seg:0, segStart:null, segEnd:null,
         segDur:0, segStartTime:null, raf:null, total:0, covered:0, lastKmMilestone:0 },
    3: { route:[], poly:null, marker:null, distances:[], animating:false, seg:0, segStart:null, segEnd:null,
         segDur:0, segStartTime:null, raf:null, total:0, covered:0, lastKmMilestone:0 }
  };

  // Bus Icons
  function busIcon(color) {
    return L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61205.png",
      iconSize: [36,36],
      iconAnchor: [18,18],
      className: "bus-icon-"+color
    });
  }

  // Helpers
  function haversine(lat1, lon1, lat2, lon2) {
    const R=6371000,toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function lerp(a,b,t){return a+(b-a)*t;}
  function formatTime(d){return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
  function speak(msg){window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));}

  // Set Route
  function setRoute(id){
    const start=document.getElementById("start"+id).value;
    const end=document.getElementById("end"+id).value;
    if(start===end){alert("Start and End cannot be same!");return;}
    const sIdx=cityOrder.findIndex(c=>c.name===start);
    const eIdx=cityOrder.findIndex(c=>c.name===end);
    let r;
    if(sIdx<eIdx) r=cityOrder.slice(sIdx,eIdx+1).map(c=>c.coords);
    else r=cityOrder.slice(eIdx,sIdx+1).map(c=>c.coords).reverse();
    let bus=buses[id];
    bus.route=r;
    if(bus.poly) map.removeLayer(bus.poly);
    bus.poly=L.polyline(r,{color:colors[id-1],weight:5}).addTo(map);
    map.fitBounds(bus.poly.getBounds(),{padding:[50,50]});
    resetAnimation(id);
    // Distances
    bus.distances=[]; bus.total=0;
    for(let i=0;i<r.length-1;i++){
      const d=haversine(r[i][0],r[i][1],r[i+1][0],r[i+1][1]);
      bus.distances.push(d); bus.total+=d;
    }
    const km=(bus.total/1000).toFixed(2);
    const etaSec=bus.total/BUS_SPEED_MPS;
    const arr=new Date(Date.now()+etaSec*1000);
    document.getElementById("eta"+id).innerText=`üöå Bus ${id} | Distance: ${km} km | ETA: ${formatTime(arr)}`;
    speak(`Bus ${id} will travel ${km} kilometers. Arrival at ${formatTime(arr)}.`);
  }

  // Start Animation
  function startAnimation(id){
    const bus=buses[id];
    if(bus.animating||bus.route.length<2)return;
    bus.animating=true; bus.seg=0; bus.covered=0; bus.lastKmMilestone=0;
    startSeg(id);
  }

  function startSeg(id){
    const bus=buses[id];
    if(bus.seg>=bus.route.length-1){bus.animating=false;speak(`Bus ${id} has finished its route.`);return;}
    bus.segStart={lat:bus.route[bus.seg][0],lng:bus.route[bus.seg][1]};
    bus.segEnd={lat:bus.route[bus.seg+1][0],lng:bus.route[bus.seg+1][1]};
    const dist=bus.distances[bus.seg];
    bus.segDur=dist/BUS_SPEED_MPS*1000;
    bus.segStartTime=null;
    bus.raf=requestAnimationFrame(ts=>step(id,ts));
  }

  function step(id,timestamp){
    const bus=buses[id];
    if(!bus.segStartTime) bus.segStartTime=timestamp;
    const elapsed=timestamp-bus.segStartTime;
    const t=Math.min(1,elapsed/bus.segDur);
    const lat=lerp(bus.segStart.lat,bus.segEnd.lat,t);
    const lng=lerp(bus.segStart.lng,bus.segEnd.lng,t);
    if(!bus.marker) bus.marker=L.marker([lat,lng],{icon:busIcon(colors[id-1])}).addTo(map);
    else bus.marker.setLatLng([lat,lng]);
    const segDist=bus.distances[bus.seg];
    const coveredNow=bus.covered+segDist*t;
    const remain=bus.total-coveredNow;
    const etaSec=remain/BUS_SPEED_MPS;
    const eta=new Date(Date.now()+etaSec*1000);
    document.getElementById("eta"+id).innerText=
      `üöå Bus ${id} | Covered ${(coveredNow/1000).toFixed(2)} km | Remaining ${(remain/1000).toFixed(2)} km | ETA: ${formatTime(eta)}`;
    // Milestone announcement every 5 km
    const kmDone=Math.floor(coveredNow/1000);
    if(kmDone>=bus.lastKmMilestone+5){
      bus.lastKmMilestone=kmDone;
      speak(`Bus ${id} has covered ${kmDone} kilometers.`);
    }
    if(t<1){bus.raf=requestAnimationFrame(ts=>step(id,ts));}
    else{
      bus.covered+=segDist;
      const city=cityOrder.find(c=>Math.abs(c.coords[0]-bus.segEnd.lat)<0.01&&Math.abs(c.coords[1]-bus.segEnd.lng)<0.01);
      if(city){speak(`Bus ${id} has reached ${city.name}.`);}
      bus.seg++; setTimeout(()=>startSeg(id),600);
    }
  }

  // Reset
  function resetAnimation(id){
    const bus=buses[id];
    cancelAnimationFrame(bus.raf);
    bus.animating=false; bus.seg=0; bus.covered=0;
    if(bus.route.length){
      if(!bus.marker) bus.marker=L.marker(bus.route[0],{icon:busIcon(colors[id-1])}).addTo(map);
      else bus.marker.setLatLng(bus.route[0]);
    }
    document.getElementById("eta"+id).innerText=`‚ÑπÔ∏è Bus ${id} info will appear here.`;
  }

  // Help & Alarm
  document.getElementById('helpBtn').onclick=()=>alert("üìñ Help:\n1. Select Start & End.\n2. Set Route.\n3. Start.\n‚òéÔ∏è Support: 1800-123-4567");
  document.getElementById('alarmBtn').onclick=()=>{speak("Emergency! Authorities have been alerted.");alert("üö® Emergency activated! Call 100 or 112.");};
  </script>
</body>
</html>
